<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æƒé™¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå±¥æ­´ä¿®æ­£ç‰ˆï¼‰</title>
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒ«ã¯å‰å›ã¾ã§ã‚’ç¶­æŒ */
        :root { --primary-blue: #0288d1; --light-blue: #e1f5fe; --deep-blue: #01579b; --accent-green: #4caf50; --bg-color: #f0f4f8; }
        body { font-family: 'Hiragino Kaku Gothic ProN', sans-serif; background: var(--bg-color); margin: 0; padding-bottom: 50px; color: #333; }
        .main-board-title { background: linear-gradient(135deg, #0288d1 0%, #01579b 100%); color: white; text-align: center; padding: 30px 10px; font-size: 42px; font-weight: 900; letter-spacing: 4px; text-shadow: 2px 2px 0px #003c6e, 4px 4px 8px rgba(0,0,0,0.5); box-shadow: 0 6px 15px rgba(0,0,0,0.2); border-bottom: 6px solid #002f56; }
        .container { background: white; max-width: 1000px; margin: 20px auto; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); min-height: 85vh; border: 1px solid #d1d9e6; }
        .page { display: none; } .active { display: block; }
        nav { display: none; justify-content: space-around; background: #263238; padding: 10px 0; position: sticky; top: 0; z-index: 100; }
        nav.staff-visible { display: flex; }
        nav button { background: #455a64; border: none; color: white; font-weight: bold; font-size: 15px; cursor: pointer; padding: 10px 15px; border-radius: 8px; }
        nav button.active-nav { background: var(--primary-blue); }
        .mode-switch { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; z-index: 1000; }
        .section-title { background: #f0f7ff; color: var(--deep-blue); padding: 10px 15px; border-left: 6px solid var(--primary-blue); border-radius: 4px; font-size: 18px; display: block; margin: 20px 0 12px; font-weight: bold; }
        .member-zone { background:#fafafa; padding:15px; border:2px dashed #cfd8dc; border-radius:15px; min-height:70px; display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px; }
        .spots-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .spot-row { display: flex; align-items: center; padding: 12px; border: 1px solid #e1e8ed; border-radius: 15px; background: #fff; box-shadow: 0 3px 6px rgba(0,0,0,0.03); transition: background-color 0.3s; }
        .spot-row.done { background-color: #e8f5e9 !important; border-color: #a5d6a7 !important; }
        .spot-info { width: 110px; font-weight: bold; color: var(--deep-blue); font-size: 17px; }
        .drop-zone { flex-grow: 1; min-height: 55px; display: flex; flex-wrap: wrap; gap: 8px; background: #f8f9fa; border-radius: 10px; padding: 8px; border: 1px solid transparent; }
        .drag-over { background: #e3f2fd !important; border-color: var(--primary-blue); }
        .helper-outer { background: #fffdf0; border: 2px solid #ffe082; border-radius: 20px; padding: 20px; margin-top: 25px; }
        .user-chip { position: relative; display: inline-block; padding: 10px 20px; background: white; border: 1.5px solid #b3e5fc; border-radius: 25px; font-weight: bold; font-size: 19px; cursor: grab; box-shadow: 0 3px 5px rgba(0,0,0,0.08); margin: 4px; color: #0277bd; }
        .del-btn { position: absolute; top: -10px; right: -10px; background: #ef5350; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 16px; cursor: pointer; display: none; z-index: 10; line-height: 24px; }
        .user-chip.show-del .del-btn { display: block; }
        .action-btn { background: #4fc3f7; color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; cursor: pointer; border-bottom: 5px solid #0288d1; width: 100%; font-size: 20px; margin: 15px 0; }
        .save-btn { background: #ef5350; border-bottom-color: #c62828; display: none; }
        .save-btn.ready { display: block; }
        .staff-only { display: none; }
        .is-staff .staff-only { display: block; }
        input[type="checkbox"] { transform: scale(2.0); margin-right: 15px; cursor: pointer; }

        @media print {
            @page { size: A4 portrait; margin: 8mm; }
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .history-item { border-bottom: 1.5px solid #000; margin-bottom: 5px; page-break-inside: avoid; }
            .history-summary { font-size: 12pt; padding: 5px 0; }
            .history-details { display: block !important; font-size: 9pt; line-height: 1.2; padding: 5px 0; }
            .print-log-entry { display: inline-block; width: 48%; border-bottom: 1px solid #eee; margin-bottom: 2px; }
        }

        .history-item { margin-bottom: 10px; border: 1px solid #e1e8ed; border-radius: 12px; background: #fff; overflow: hidden; }
        .history-summary { padding: 15px 20px; background: #f5f8fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 16px; font-weight: bold; color: #455a64; }
        .history-item.open .history-details { display: block; }
        .history-item.open .history-summary { background: #e1f5fe; color: var(--deep-blue); }
        .history-details { display: none; padding: 15px; background: #fff; border-top: 1px solid #f0f0f0; color: #607d8b; }
        .history-del { background: #ff8a80; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; }
    </style>
</head>
<body onclick="clearAllDels()">

<div class="main-board-title">ğŸ§¹ æƒé™¤å½“ç•ªãƒœãƒ¼ãƒ‰</div>
<button class="mode-switch" onclick="toggleStaffMode()" id="modeLabel">ğŸ”“ ã‚¹ã‚¿ãƒƒãƒ•ç”¨</button>

<nav id="staffNav">
    <button onclick="showPage('historyPage')" id="nav-historyPage">ğŸ“ å±¥æ­´</button>
    <button onclick="showPage('mainPage')" id="nav-mainPage" class="active-nav">ğŸ  å½“ç•ªè¡¨</button>
    <button onclick="showPage('setupPage')" id="nav-setupPage">âš™ï¸ è¨­å®š</button>
</nav>

<div class="container" id="mainContainer">
    <div id="mainPage" class="page active">
        <div class="staff-only">
            <div class="section-title">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ã®å‰²ã‚ŠæŒ¯ã‚Š</div>
            <div id="memberPool" class="member-zone" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
            <div class="section-title" style="border-color:#ffa726;">â¸ï¸ ãŠä¼‘ã¿ãƒ»å¾…æ©Ÿ</div>
            <div id="waitPool" class="member-zone" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
            <button class="action-btn" onclick="runShuffle()">ğŸ² ãƒ¡ãƒ³ãƒãƒ¼ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼</button>
        </div>
        <div class="section-title">ğŸ“ ä»Šæ—¥ã®æƒé™¤ã‚¨ãƒªã‚¢</div>
        <div id="spotsList" class="spots-grid"></div>
        <div class="helper-outer" id="helperContainer">
            <div class="section-title" style="border-color:#ffd54f; background:none;">ğŸƒ ãŠåŠ©ã‘ã‚¨ãƒªã‚¢</div>
            <div id="helperList" class="spots-grid"></div>
        </div>
        <button id="saveBtn" class="action-btn save-btn" onclick="manualSave()">âœ… å…¨å“¡å®Œäº†ï¼ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <div id="historyPage" class="page">
        <h2 style="font-size: 22px; color: var(--deep-blue);" class="no-print">ğŸ“ æƒé™¤ã®è¨˜éŒ²</h2>
        <div style="margin-bottom:20px;" class="no-print">
            <select id="monthFilter" onchange="renderHistoryList()" style="padding:12px; width:100%; border-radius:10px; font-size:18px;"></select>
        </div>
        <div id="print-area"><div id="historyContainer"></div></div>
        <button class="action-btn no-print" style="background:#78909c;" onclick="window.print()">ğŸ–¨ï¸ ã“ã®å±¥æ­´ã‚’å°åˆ·ã™ã‚‹</button>
    </div>

    <div id="setupPage" class="page">
        <h2 style="font-size: 22px;">âš™ï¸ è¨­å®š</h2>
        <p>ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</p><input type="password" id="pwInput">
        <p>ğŸ‘¥ åˆ©ç”¨è€…ãƒªã‚¹ãƒˆ</p><textarea id="memberInput" style="height:150px;"></textarea>
        <p>ğŸ“ åŸºæœ¬ã‚¨ãƒªã‚¢</p><textarea id="spotInput" style="height:100px;"></textarea>
        <p>ğŸƒ ãŠåŠ©ã‘ã‚¨ãƒªã‚¢</p><textarea id="helperInput" style="height:100px;"></textarea>
        <button class="action-btn" style="background:#0097a7;" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
    </div>
</div>

<script>
let isStaff = false;

// åŸºæœ¬æ©Ÿèƒ½
function toggleStaffMode() {
    if (!isStaff) {
        const input = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");
        const correctPw = localStorage.getItem('v36_pw') || "1234";
        if (input === correctPw) { isStaff = true; applyMode(); }
    } else { isStaff = false; applyMode(); showPage('mainPage'); }
}
function applyMode() {
    const nav = document.getElementById('staffNav'); const label = document.getElementById('modeLabel');
    if (isStaff) { document.body.classList.add('is-staff'); nav.classList.add('staff-visible'); label.innerText = "ğŸ”’ åˆ©ç”¨è€…ãƒ¢ãƒ¼ãƒ‰"; }
    else { document.body.classList.remove('is-staff'); nav.classList.remove('staff-visible'); label.innerText = "ğŸ”“ ã‚¹ã‚¿ãƒƒãƒ•ç”¨"; }
}
function clearAllDels() { document.querySelectorAll('.user-chip').forEach(c => c.classList.remove('show-del')); }

window.onload = function() {
    document.getElementById('pwInput').value = localStorage.getItem('v36_pw') || "1234";
    document.getElementById('memberInput').value = localStorage.getItem('v36_m') || "ç”°ä¸­â™¦!æƒé™¤ãƒªãƒ¼ãƒ€ãƒ¼\nä½è—¤â™¢!æƒé™¤ãƒªãƒ¼ãƒ€ãƒ¼\néˆ´æœ¨â™¦\né«˜æ©‹â™¢";
    document.getElementById('spotInput').value = localStorage.getItem('v36_s') || "æƒé™¤ãƒªãƒ¼ãƒ€ãƒ¼\nå¥³å­ãƒˆã‚¤ãƒ¬\nç”·å­ãƒˆã‚¤ãƒ¬\nãƒ•ãƒ­ã‚¢";
    document.getElementById('helperInput').value = localStorage.getItem('v36_h') || "å…¥å£\næ‰‰æ‹­ã";
    initBoard(); applyMode();
};

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-nav'));
    document.getElementById(pageId).classList.add('active');
    document.getElementById('nav-' + pageId).classList.add('active-nav');
    if(pageId === 'historyPage') { updateMonthFilter(); renderHistoryList(); }
}

function initBoard() {
    document.getElementById('memberPool').innerHTML = "";
    document.getElementById('memberInput').value.trim().split('\n').filter(n => n.trim() !== "").forEach((m, i) => { 
        document.getElementById('memberPool').appendChild(createChip("u-" + i, m, false)); 
    });
    const createRows = (targetId, text) => {
        const list = document.getElementById(targetId); list.innerHTML = "";
        text.split('\n').filter(s => s.trim() !== "").forEach(s => { 
            list.innerHTML += `<div class="spot-row"><input type="checkbox" class="check-done" onclick="checkStatus()"><div class="spot-info">${s}</div><div class="drop-zone" ondragover="allowDrop(event)" ondrop="drop(event)" data-spot="${s}"></div></div>`; 
        });
    };
    createRows('spotsList', document.getElementById('spotInput').value.trim()); 
    createRows('helperList', document.getElementById('helperInput').value.trim());
    checkStatus();
}

function createChip(id, fullName, isHelperChip = false) {
    const chip = document.createElement('div');
    chip.className = "user-chip"; chip.id = id; chip.draggable = true;
    chip.innerText = fullName.split(/[!â™¢â™¦]/)[0]; chip.dataset.full = fullName;
    chip.dataset.isHelper = isHelperChip;
    chip.onclick = (e) => { e.stopPropagation(); const was = chip.classList.contains('show-del'); clearAllDels(); if (!was) chip.classList.add('show-del'); };
    chip.ondragstart = (e) => {
        e.dataTransfer.setData("text", e.target.id);
        chip.dataset.originZone = chip.parentElement.closest('.spots-grid') ? chip.parentElement.closest('.spots-grid').id : "pool";
    };
    const del = document.createElement('button'); del.className = "del-btn"; del.innerText = "Ã—";
    del.onclick = (e) => { e.stopPropagation(); if (chip.dataset.isHelper === "true") { chip.remove(); } else { document.getElementById('memberPool').appendChild(chip); } checkStatus(); };
    chip.appendChild(del); return chip;
}

function checkStatus() {
    let canSave = true, hasAnyOne = false;
    document.querySelectorAll('.spot-row').forEach(row => {
        const cb = row.querySelector('.check-done');
        const hasMember = row.querySelector('.user-chip') !== null;
        if (cb.checked) row.classList.add('done'); else row.classList.remove('done');
        if (hasMember) { hasAnyOne = true; if (!cb.checked) canSave = false; }
    });
    const btn = document.getElementById('saveBtn');
    if (canSave && hasAnyOne) btn.classList.add('ready'); else btn.classList.remove('ready');
}

// ã€âœ¨ ä¿®æ­£ï¼šä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ã€‘
function manualSave() {
    let currentData = [];
    let leaderName = "æœªè¨­å®š";

    document.querySelectorAll('.spot-row').forEach((row, index) => {
        const spot = row.querySelector('.spot-info').innerText;
        const chips = Array.from(row.querySelectorAll('.user-chip')).map(c => c.innerText);
        if (chips.length > 0) {
            currentData.push(`${chips.join('ï¼†')} (${spot})`);
            if (index === 0) leaderName = chips.join('ï¼†');
        }
    });

    const now = new Date();
    const ym = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`;
    const dateStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

    const logs = JSON.parse(localStorage.getItem('v36_logs') || "[]");
    logs.unshift({ 
        id: Date.now(), 
        month: ym, 
        date: dateStr, 
        leader: leaderName, 
        data: currentData 
    });
    
    localStorage.setItem('v36_logs', JSON.stringify(logs));
    
    // ãŠç–²ã‚Œæ§˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    alert("ä¿å­˜ã—ã¾ã—ãŸï¼ä»Šæ—¥ã‚‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼âœ¨");
    
    // ä¿å­˜å¾Œã«ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ãªã©ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†ï¼ˆä»»æ„ï¼‰
    document.getElementById('saveBtn').classList.remove('ready');
}

// å±¥æ­´è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
function updateMonthFilter() {
    const logs = JSON.parse(localStorage.getItem('v36_logs') || "[]");
    const months = [...new Set(logs.map(log => log.month))];
    const filter = document.getElementById('monthFilter');
    if (filter) {
        filter.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
        // æœ€æ–°ã®æœˆã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        if (months.length > 0) filter.value = months[0];
    }
}

function renderHistoryList() {
    const filter = document.getElementById('monthFilter').value;
    const container = document.getElementById('historyContainer');
    const logs = JSON.parse(localStorage.getItem('v36_logs') || "[]").filter(log => log.month === filter);
    
    if (logs.length === 0) {
        container.innerHTML = "<p>ã“ã®æœˆã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
    }

    container.innerHTML = logs.map(log => `
        <div class="history-item" onclick="this.classList.toggle('open')">
            <div class="history-summary">
                <span>ğŸ“… ${log.date} ï¼ ğŸ‘‘ ${log.leader}</span>
                <span class="no-print">${isStaff ? `<button class="history-del" onclick="deleteHistory(${log.id}, event)">å‰Šé™¤</button>` : 'â–¼'}</span>
            </div>
            <div class="history-details">
                ${log.data.map(d => `<div class="print-log-entry">${d}</div>`).join('')}
            </div>
        </div>
    `).join('');
}

function deleteHistory(id, event) {
    event.stopPropagation();
    if (!confirm("ã“ã®æ—¥ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã„ã„ï¼Ÿ")) return;
    let logs = JSON.parse(localStorage.getItem('v36_logs') || "[]");
    logs = logs.filter(log => log.id !== id);
    localStorage.setItem('v36_logs', JSON.stringify(logs));
    updateMonthFilter();
    renderHistoryList();
}

// ãã®ä»–è£œåŠ©
function allowDrop(e) { e.preventDefault(); e.target.closest('.member-zone, .drop-zone').classList.add('drag-over'); }
function drop(e) {
    e.preventDefault(); const zone = e.target.closest('.member-zone, .drop-zone'); zone.classList.remove('drag-over');
    const id = e.dataTransfer.getData("text"); const original = document.getElementById(id);
    if (!original) return;
    const originIsSpots = original.dataset.originZone === "spotsList";
    const targetIsSpots = !!zone.closest('#spotsList');
    if (!isStaff) {
        if (originIsSpots && targetIsSpots) return;
        if (originIsSpots && zone.classList.contains('member-zone')) return;
        if (!originIsSpots && targetIsSpots) return;
    }
    if (original.dataset.isHelper === "true" && targetIsSpots) return;
    if (zone.classList.contains('drop-zone')) {
        const spotName = zone.dataset.spot, mData = original.dataset.full;
        if (original.dataset.isHelper !== "true" && !!zone.closest('#helperContainer')) {
            zone.appendChild(createChip("h-" + Math.random(), mData, true));
            checkStatus(); return;
        }
    }
    zone.appendChild(original); checkStatus();
}
function runShuffle() {
    const allDropZones = Array.from(document.querySelectorAll('#spotsList .drop-zone'));
    allDropZones.forEach(z => { while(z.firstChild) document.getElementById('memberPool').appendChild(z.firstChild); });
    const chips = Array.from(document.querySelectorAll('#memberPool .user-chip')); chips.sort(() => Math.random() - 0.5);
    allDropZones.forEach((zone) => {
        if (chips.length > 0) zone.appendChild(chips.splice(0, 1)[0]);
    });
    checkStatus();
}
function saveSettings() {
    localStorage.setItem('v36_pw', document.getElementById('pwInput').value);
    localStorage.setItem('v36_m', document.getElementById('memberInput').value);
    localStorage.setItem('v36_s', document.getElementById('spotInput').value);
    localStorage.setItem('v36_h', document.getElementById('helperInput').value);
    initBoard(); isStaff = false; applyMode(); showPage('mainPage');
}
</script>
</body>
</html>